name: Web Crawler

on:
  workflow_dispatch:
    inputs:
      url:
        description: "URL to crawl (e.g. https://realfirmware.net)"
        required: true
        type: string
      depth:
        description: "Maximum crawl depth (0 = unlimited)"
        required: false
        default: "1000000"
        type: string
      delay:
        description: "Delay between requests in seconds"
        required: false
        default: "0.25"
        type: string
      no_robots:
        description: "Ignore robots.txt restrictions"
        required: false
        default: false
        type: boolean
      create_repo:
        description: "Create a new repository with the crawled site"
        required: false
        default: false
        type: boolean
      repo_owner:
        description: "User or organization for the new repository (required if create_repo is true)"
        required: false
        default: ""
        type: string
      git_push_every:
        description: "Commit and push crawled files every N saved files (0 = disabled, requires create_repo)"
        required: false
        default: "100"
        type: string

permissions:
  contents: write

jobs:
  crawl:
    name: "Crawl ${{ inputs.url }}"
    runs-on: aapt

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Generate normalized repo name
        id: reponame
        run: |
          python3 -c "
          import re, sys
          url = sys.argv[1]
          # Remove scheme
          name = re.sub(r'^https?://', '', url)
          # Replace non-alphanumeric chars with hyphens
          name = re.sub(r'[^a-zA-Z0-9]+', '-', name)
          # Remove leading/trailing hyphens
          name = name.strip('-').lower()
          # Truncate to 100 chars max (GitHub limit)
          name = name[:100]
          print(f'name={name}')
          " "${{ inputs.url }}" >> "$GITHUB_OUTPUT"

      - name: Create repository for live progress
        if: inputs.create_repo == true
        id: create_repo
        env:
          ONT_TOKEN: ${{ secrets.ONT }}
        run: |
          set -euo pipefail

          REPO_BASE="${{ steps.reponame.outputs.name }}"
          OWNER="${{ inputs.repo_owner }}"

          if [ -z "$OWNER" ]; then
            RESP=$(curl -sS -w "\n%{http_code}" -H "Authorization: token $ONT_TOKEN" \
              https://api.github.com/user)
            HTTP_CODE=$(echo "$RESP" | tail -1)
            BODY=$(echo "$RESP" | sed '$d')
            if [ "$HTTP_CODE" != "200" ]; then
              echo "::error::Failed to get user info (HTTP $HTTP_CODE): $BODY"
              exit 1
            fi
            OWNER=$(echo "$BODY" | python3 -c "import sys,json; print(json.load(sys.stdin)['login'])")
          fi

          echo "Target owner: $OWNER"

          # Check if a repo already exists and find next available name
          REPO_NAME="$REPO_BASE"
          COPY=0
          MAX_COPIES=10
          while true; do
            HTTP_CODE=$(curl -sS -o /dev/null -w "%{http_code}" \
              -H "Authorization: token $ONT_TOKEN" \
              "https://api.github.com/repos/${OWNER}/${REPO_NAME}")
            if [ "$HTTP_CODE" = "404" ]; then
              break
            elif [ "$HTTP_CODE" != "200" ]; then
              echo "::error::Unexpected response (HTTP $HTTP_CODE) checking repo ${OWNER}/${REPO_NAME}. Verify your token and permissions."
              exit 1
            fi
            COPY=$((COPY + 1))
            if [ "$COPY" -gt "$MAX_COPIES" ]; then
              echo "::error::Exceeded maximum of $MAX_COPIES name attempts. Please delete old repos or choose a different name."
              exit 1
            fi
            REPO_NAME="${REPO_BASE}-${COPY}"
            echo "Repo exists, trying: $REPO_NAME"
          done

          echo "Creating repository: ${OWNER}/${REPO_NAME}"

          # Detect if owner is a user or an organization
          RESP=$(curl -sS -w "\n%{http_code}" -H "Authorization: token $ONT_TOKEN" \
            "https://api.github.com/users/${OWNER}")
          HTTP_CODE=$(echo "$RESP" | tail -1)
          BODY=$(echo "$RESP" | sed '$d')
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Failed to get owner info (HTTP $HTTP_CODE): $BODY"
            exit 1
          fi
          OWNER_TYPE=$(echo "$BODY" | python3 -c "import sys,json; print(json.load(sys.stdin).get('type','User'))")

          if [ "$OWNER_TYPE" = "Organization" ]; then
            API_URL="https://api.github.com/orgs/${OWNER}/repos"
          else
            API_URL="https://api.github.com/user/repos"
          fi

          RESP=$(curl -sS -w "\n%{http_code}" -X POST \
            -H "Authorization: token $ONT_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$API_URL" \
            -d "{
              \"name\": \"${REPO_NAME}\",
              \"description\": \"Crawled site: ${{ inputs.url }}\",
              \"private\": false,
              \"auto_init\": false
            }")
          HTTP_CODE=$(echo "$RESP" | tail -1)
          BODY=$(echo "$RESP" | sed '$d')
          if [ "$HTTP_CODE" != "201" ]; then
            echo "::error::Failed to create repository (HTTP $HTTP_CODE): $BODY"
            exit 1
          fi
          echo "âœ… Repository created: ${OWNER}/${REPO_NAME}"

          # Initialize git in the output directory
          mkdir -p downloaded_site
          cd downloaded_site
          git init
          git config user.name "Web Crawler Bot"
          git config user.email "crawler@users.noreply.github.com"
          git config credential.helper '!f() { echo "password=$ONT_TOKEN"; }; f'
          git remote add origin "https://x-access-token@github.com/${OWNER}/${REPO_NAME}.git"
          git checkout -b main

          # Initial commit so push works
          echo "# Crawl of ${{ inputs.url }}" > README.md
          echo "" >> README.md
          echo "- **Depth**: ${{ inputs.depth }}" >> README.md
          echo "- **Delay**: ${{ inputs.delay }}s" >> README.md
          echo "- **Run**: #${{ github.run_number }}" >> README.md
          echo "- **Status**: ðŸ”„ Crawling in progressâ€¦" >> README.md
          git add -A
          git commit -m "Initial commit â€“ crawl starting"
          git push -u origin main

          echo "repo_ready=true" >> "$GITHUB_OUTPUT"
          echo "repo_full=${OWNER}/${REPO_NAME}" >> "$GITHUB_OUTPUT"

      - name: Run web crawler
        env:
          ONT_TOKEN: ${{ secrets.ONT }}
        run: |
          # Re-apply git credentials if repo was created
          if [ "${{ steps.create_repo.outputs.repo_ready }}" = "true" ]; then
            cd downloaded_site
            git config credential.helper '!f() { echo "password=$ONT_TOKEN"; }; f'
            cd ..
          fi

          GIT_PUSH_ARG=""
          if [ "${{ steps.create_repo.outputs.repo_ready }}" = "true" ] && [ "${{ inputs.git_push_every }}" != "0" ]; then
            GIT_PUSH_ARG="--git-push-every ${{ inputs.git_push_every }}"
          fi

          python -m web_crawler "${{ inputs.url }}" \
            --depth "${{ inputs.depth }}" \
            --delay "${{ inputs.delay }}" \
            --output downloaded_site \
            ${{ inputs.no_robots && '--no-robots' || '' }} \
            $GIT_PUSH_ARG

      - name: Final push of remaining files
        if: inputs.create_repo == true && steps.create_repo.outputs.repo_ready == 'true'
        env:
          ONT_TOKEN: ${{ secrets.ONT }}
        run: |
          cd downloaded_site
          git config credential.helper '!f() { echo "password=$ONT_TOKEN"; }; f'

          # Update README with completion status
          REPO_FULL="${{ steps.create_repo.outputs.repo_full }}"
          sed -i 's/ðŸ”„ Crawling in progressâ€¦/âœ… Crawl complete/' README.md

          git add -A
          git diff --cached --quiet || git commit -m "Crawl complete: ${{ inputs.url }}"
          git push

      - name: Zip downloaded site
        run: |
          cd downloaded_site
          zip -r ../crawl-${{ steps.reponame.outputs.name }}.zip . -x '.git/*' -x '.git'

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: "crawl-${{ steps.reponame.outputs.name }}"
          path: downloaded_site/
          retention-days: 90

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "crawl-${{ steps.reponame.outputs.name }}-${{ github.run_number }}"
          name: "Crawl ${{ inputs.url }} (#${{ github.run_number }})"
          body: |
            ## Web Crawl Results

            - **URL**: ${{ inputs.url }}
            - **Depth**: ${{ inputs.depth }}
            - **Delay**: ${{ inputs.delay }}s
            - **robots.txt ignored**: ${{ inputs.no_robots }}
            - **Run**: #${{ github.run_number }}
            ${{ steps.create_repo.outputs.repo_ready == 'true' && format('- **Live repo**: https://github.com/{0}', steps.create_repo.outputs.repo_full) || '' }}
          files: "crawl-${{ steps.reponame.outputs.name }}.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
